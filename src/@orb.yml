version: 2.1

orbs:
    aws-cli: circleci/aws-cli@0.1.11

description: |
    Disables reruns of workflows. Source https://github.com/johnstonjacob/disable-rerun-orb

references:
    default_parameters: &default_parameters
        parameters:
            s3-bucket:
                type: env_var_name
                description: the s3 bucket name, without protocol.
                default: DISABLE_RERUN_S3_BUCKET
            s3-key:
                type: env_var_name
                description: key inside of s3 bucket
                default: DISABLE_RERUN_S3_KEY
            s3-region:
                type: env_var_name
                description: s3 bucket region
                default: DISABLE_RERUN_S3_REGION
            tag-override:
                type: string
                description: Git commit message to override rerun disable
                default: "[CCI ENABLE RERUN]"


commands:
    mark-build-ran:
        description: Marks build as ran
        <<: *default_parameters
        steps:
            - aws-cli/install
            - aws-cli/configure
            - run:
                name: Create build file
                command: touch ~/$(echo $CIRCLE_SHA1)
            - run:
                name: Upload build file to S3
                command: aws s3 cp ~/$(echo $CIRCLE_SHA1) "s3://$<< parameters.s3-bucket>>/$<< parameters.s3-key>>/$(echo $CIRCLE_SHA1)"
    check-build-ran:
        description: Checks if the build ran previously
        <<: *default_parameters
        steps:
            - aws-cli/install
            - aws-cli/configure
            - checkout:
                path: ~/proj
            - run:
                name: Check if build has been ran
                command: |
                    cd ~/proj
                    if [[ $(git log --format=%B -n 1 HEAD) == "<< parameters.tag-override >>" ]]; then
                        echo "Disable rerun override enabled"
                        exit 0
                    fi
                    echo "s3://$<< parameters.s3-bucket>>/$<< parameters.s3-key>>/$(echo $CIRCLE_SHA1)"
                    echo "Checking if build has been previously ran.."
                    aws s3 ls "s3://$<< parameters.s3-bucket>>/$<< parameters.s3-key>>/$(echo $CIRCLE_SHA1)"
    unmark-build-ran:
        description: unmarks build as ran
        <<: *default_parameters
        steps:
            - aws-cli/install
            - aws-cli/configure
            - run:
                name: Removes build file from S3
                command: aws s3 rm ~/$(echo $CIRCLE_SHA1) "s3://$<< parameters.s3-bucket>>/$<< parameters.s3-key>>/$(echo $CIRCLE_SHA1)"
