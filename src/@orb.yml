version: 2.1

orbs:
    aws-cli: circleci/aws-cli@0.1.11

description: |
    Disables reruns of workflows. Source https://github.com/johnstonjacob/disable-rerun-orb

commands:
    mark-build-ran:
        description: Marks build as ran
        parameters:
            s3-bucket:
                type: env_var_name
                description: the s3 bucket name, without protocol.
                default: DISABLE_RERUN_S3_BUCKET
            s3-key:
                type: env_var_name
                description: key inside of s3 bucket
                default: DISABLE_RERUN_S3_KEY
        steps:
            - aws-cli/install
            - aws-cli/configure
            - run:
                name: Create build file
                command: touch ~/$(echo $CIRCLE_SHA1)
            - run:
                name: Upload build file to S3
                command: aws s3 cp ~/$(echo $CIRCLE_SHA1) "s3://$<< parameters.s3-bucket>>/$<< parameters.s3-key>>/$(echo $CIRCLE_SHA1)"
    check-build-ran:
        description: Checks if the build ran previously
        parameters:
            s3-bucket:
                type: env_var_name
                description: the s3 bucket name, without protocol.
                default: DISABLE_RERUN_S3_BUCKET
            s3-key:
                type: env_var_name
                description: key inside of s3 bucket
                default: DISABLE_RERUN_S3_KEY
            tag-override:
                type: string
                description: Git commit message to override rerun disable
                default: "[CCI ENABLE RERUN]"
            test-override:
                type: boolean
                default: false

        steps:
            - aws-cli/install
            - aws-cli/configure
            - checkout:
                path: ~/proj
            - run:
                name: Check if build has been ran previously.
                command: |
                    cd ~/proj
                    if [[ $(git log --format=%B -n 1 HEAD) == "<< parameters.tag-override >>" ]]; then
                        echo "Disable rerun override enabled"
                        exit 0
                    fi
                    echo "s3://$<< parameters.s3-bucket>>/$<< parameters.s3-key>>/$(echo $CIRCLE_SHA1)"
                    echo "Checking if build has been previously ran.."
                    if ! aws s3 ls "s3://$<< parameters.s3-bucket>>/$<< parameters.s3-key>>/$(echo $CIRCLE_SHA1)"
                    then
                        exit 0
                    fi
                    if << parameters.test-override >>
                    then
                        echo "Build was ran. Test mode enabled. Exiting with code 0.."
                        exit 0
                    fi
                    echo "Build was ran previously. Exiting."
                    exit 1
    unmark-build-ran:
        description: unmarks build as ran
        parameters:
            s3-bucket:
                type: env_var_name
                description: the s3 bucket name, without protocol.
                default: DISABLE_RERUN_S3_BUCKET
            s3-key:
                type: env_var_name
                description: key inside of s3 bucket
                default: DISABLE_RERUN_S3_KEY
        steps:
            - aws-cli/install
            - aws-cli/configure
            - run:
                name: Removes build file from S3
                command: aws s3 rm "s3://$<< parameters.s3-bucket>>/$<< parameters.s3-key>>/$(echo $CIRCLE_SHA1)"
